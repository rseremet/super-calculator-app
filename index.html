<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>‚ú® DeshMoney Pro Final</title>
    <style>
        /* ==================================== */
        /* 1. –¶–≤–µ—Ç–æ–≤–∞—è –ü–∞–ª–∏—Ç—Ä–∞ –∏ –°—Ç–∏–ª–∏ Dark Mode */
        /* ==================================== */
        :root {
            --app-bg: #12121D;
            --block-bg: #1E1E30;
            --accent-indigo: #6200EE;
            --accent-red: #D32F2F;
            --text-main: #E0E0FF;
            --text-secondary: #A0A0C0;
            --graph-color: #BB86FC; 
            --divider: #32324A;
            --button-normal: #32324A;
            --button-hover: #45456A;
            --button-active: #5C5C85;
            --alt-row-bg: #1A1A2B; 
            --shadow-color: rgba(0, 0, 0, 0.4);
        }
        
        body {
            font-family: 'Inter', 'SF Pro Display', Arial, sans-serif;
            background-color: var(--app-bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 450px;
            background: var(--block-bg);
            border-radius: 15px;
            box-shadow: 0 10px 40px var(--shadow-color);
            overflow: hidden;
            min-height: 600px;
        }

        h2 {
            color: var(--text-main);
            text-align: center;
            margin-bottom: 15px;
            padding-top: 20px;
            font-size: 1.8em;
        }
        
        /* –¢–∞–±—ã */
        .tabs {
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid var(--divider);
            margin-bottom: 20px;
            background-color: var(--button-normal);
        }

        .tab-button {
            flex-grow: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-bottom 0.2s;
        }

        .tab-button.active {
            color: var(--graph-color);
            border-bottom: 2px solid var(--graph-color);
        }
        
        .tab-content {
            padding: 0 25px 25px 25px;
            display: none;
            /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–¥ —Ç–∞–±–∞–º–∏ */
            position: relative; 
            width: calc(100% - 50px);
            box-sizing: border-box;
        }

        .tab-content.active {
            display: block;
        }
        
        /* –û–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–≤–æ–¥–∞ */
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .currency-select, .form-input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            background: var(--button-normal);
            color: var(--text-main);
            border: 1px solid var(--divider);
            font-size: 1em;
            box-sizing: border-box;
        }
        
        #input-value, #resale-price, #resale-cost, #resale-sale-price {
            font-size: 2.2em;
            text-align: right;
            border: 1px solid var(--divider);
            padding: 15px 10px;
            margin-bottom: 20px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            background: var(--button-normal); /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ñ–æ–Ω —Ç–µ–º–Ω—ã–π */
            color: var(--text-main);
        }

        /* –ö–Ω–æ–ø–∫–∏ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ */
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 18px 0;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.1s, transform 0.1s;
            background: var(--button-normal);
            color: var(--text-main);
            font-weight: 500;
        }

        /* Fluid Animation */
        .btn:active {
            transform: scale(1.05);
            background-color: var(--button-hover);
        }

        .btn.operator {
            background-color: var(--accent-indigo); 
            color: var(--text-main);
            font-weight: bold;
        }
        
        .btn.clear, .btn.backspace { 
            background-color: var(--accent-red);
            color: var(--text-main);
        }
        
        /* –ë—ã—Å—Ç—Ä–∞—è –±–∞–∑–∞ */
        .quick-base-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .quick-base-buttons .btn {
            flex-grow: 1;
            padding: 10px 0;
            font-size: 1em;
            background: var(--divider);
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –ö—É—Ä—Å—ã (–ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ñ–æ–Ω–∞ –∏ –°–≤–µ—á–µ–Ω–∏–µ) */
        .currency-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 2px 0;
            border-radius: 4px;
        }
        
        /* –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ñ–æ–Ω–∞ */
        .currency-item:nth-child(even) {
            background-color: var(--alt-row-bg);
        }
        
        .currency-rate, .resale-value {
            font-weight: 700;
            color: var(--graph-color); 
            font-size: 1.1em;
            text-shadow: 0 0 3px rgba(187, 134, 252, 0.4); 
        }
        
        .rate-trend {
            margin-left: 8px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .up { color: #4CAF50; } 
        .down { color: #D32F2F; } 
        
    </style>
</head>
<body>
    <div class="container">
        <h2>DeshMoney Pro</h2>

        <div class="tabs">
            <div class="tab-button active" onclick="openTab('calculator')">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
            <div class="tab-button" onclick="openTab('resale')">üíº –†–µ—Å–µ–π–ª</div>
            <div class="tab-button" onclick="openTab('rates')">üìà –ö—É—Ä—Å—ã/–ò—Å—Ç–æ—Ä–∏—è</div>
        </div>

        <div id="calculator" class="tab-content active">
            <div class="input-group">
                <label for="base-currency-calc" style="color: var(--text-secondary);">–ë–∞–∑–∞:</label>
                <select id="base-currency-calc" class="currency-select" onchange="updateConverter(input.value)">
                    <option value="USD">üá∫üá∏ USD</option>
                    <option value="EUR">üá™üá∫ EUR</option>
                    <option value="CNY">üá®üá≥ CNY</option>
                    <option value="UAH">üá∫üá¶ UAH</option>
                    <option value="PLN">üáµüá± PLN</option>
                </select>
                <button class="base-switch-btn" onclick="quickSwitchBase('CNY')">üá®üá≥</button>
                <button class="base-switch-btn" onclick="quickSwitchBase('PLN')">üáµüá±</button>
            </div>
            
            <input type="text" id="input-value" value="0" readonly>

            <div class="quick-base-buttons">
                <button class="btn" onclick="setQuickBase(10)">10</button>
                <button class="btn" onclick="setQuickBase(50)">50</button>
                <button class="btn" onclick="setQuickBase(100)">100</button>
                <button class="btn" onclick="setQuickBase(1000)">1000</button>
            </div>

            <div class="calculator-buttons">
                <button class="btn clear" onclick="clearInput()">C</button>
                <button class="btn backspace" onclick="backspaceInput()">‚å´</button>
                <button class="btn operator" onclick="appendInput('/')">√∑</button>
                <button class="btn operator" onclick="calculateResult()">=</button>

                <button class="btn" onclick="appendInput('7')">7</button>
                <button class="btn" onclick="appendInput('8')">8</button>
                <button class="btn" onclick="appendInput('9')">9</button>
                <button class="btn operator" onclick="appendInput('+')">+</button>

                <button class="btn" onclick="appendInput('4')">4</button>
                <button class="btn" onclick="appendInput('5')">5</button>
                <button class="btn" onclick="appendInput('6')">6</button>
                <button class="btn operator" onclick="appendInput('-')">-</button>

                <button class="btn" onclick="appendInput('1')">1</button>
                <button class="btn" onclick="appendInput('2')">2</button>
                <button class="btn" onclick="appendInput('3')">3</button>
                <button class="btn" onclick="appendInput('.')">.</button>

                <button class="btn" onclick="appendInput('0')">0</button>
                <button class="btn" onclick="appendInput('000')">000</button>
            </div>

            <div class="section-title" style="color: var(--text-secondary);">–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è (–ò–∑–±—Ä–∞–Ω–Ω–æ–µ)</div>
            <div id="converter-results">
                </div>
        </div>
        
        <div id="resale" class="tab-content">
            <div class="input-group">
                <label for="resale-base-currency" style="color: var(--text-secondary);">–ü–æ–∫—É–ø–∫–∞ (–ë–∞–∑–∞):</label>
                <select id="resale-base-currency" class="currency-select" onchange="calculateResale()">
                    <option value="CNY">üá®üá≥ CNY (–Æ–∞–Ω—å)</option>
                    <option value="USD">üá∫üá∏ USD (–î–æ–ª–ª–∞—Ä)</option>
                </select>
            </div>
            
            <input type="number" id="resale-cost" class="form-input" placeholder="–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å)" oninput="calculateResale()">

            <div class="input-group">
                <label for="resale-target-currency" style="color: var(--text-secondary);">–ü—Ä–æ–¥–∞–∂–∞ (–¶–µ–ª—å):</label>
                <select id="resale-target-currency" class="currency-select" onchange="calculateResale()">
                    <option value="PLN">üáµüá± PLN (–ó–ª–æ—Ç—ã–π)</option>
                    <option value="EUR">üá™üá∫ EUR (–ï–≤—Ä–æ)</option>
                    <option value="USD">üá∫üá∏ USD (–î–æ–ª–ª–∞—Ä)</option>
                </select>
            </div>
            
            <div class="section-title" style="border-top: none; color: var(--text-secondary);">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>

            <div class="input-group">
                <label for="resale-commission" style="color: var(--text-secondary);">–ö–æ–º–∏—Å—Å–∏—è (–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞):</label>
                <input type="number" id="resale-commission" class="form-input" value="10" placeholder="%" oninput="calculateResale()">
            </div>
            
            <div class="input-group">
                <label for="resale-shipping" style="color: var(--text-secondary);">–î–æ—Å—Ç–∞–≤–∫–∞ (–§–∏–∫—Å):</label>
                <input type="number" id="resale-shipping" class="form-input" value="15" placeholder="–í –≤–∞–ª—é—Ç–µ –ø—Ä–æ–¥–∞–∂–∏" oninput="calculateResale()">
            </div>
            
            <div class="input-group">
                <label for="resale-vat" style="color: var(--text-secondary);">–ù–î–°/–ü–æ—à–ª–∏–Ω–∞:</label>
                <input type="number" id="resale-vat" class="form-input" value="0" placeholder="% (–ù–î–°, 23% –≤ PL)" oninput="calculateResale()">
            </div>
            
            <input type="number" id="resale-sale-price" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏ (Gross)" oninput="calculateResale()">

            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn operator" style="width: 100%; padding: 12px; font-size: 1em;" onclick="saveDeal()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –°–¥–µ–ª–∫—É (Receipt)
                </button>
            </div>

            <div id="resale-output">
                <div class="resale-row">
                    <span class="resale-label" style="color: var(--text-secondary);">–¶–µ–Ω–∞ –ü—Ä–æ–¥–∞–∂–∏ (—á–∏—Å—Ç–∞—è)</span>
                    <span class="resale-value" id="res-sale-net">0.00</span>
                </div>
                <div class="resale-row">
                    <span class="resale-label" style="color: var(--text-secondary);">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–≤ —Ü–µ–ª–µ–≤–æ–π –≤–∞–ª—é—Ç–µ)</span>
                    <span class="resale-value" id="res-cost-target">0.00</span>
                </div>
                 <div class="resale-row">
                    <span class="resale-label" style="color: var(--text-secondary);">–ß–∏—Å—Ç–∞—è –ü—Ä–∏–±—ã–ª—å</span>
                    <span class="resale-value" id="res-profit">0.00</span>
                </div>
                <div class="resale-row" style="margin-top: 15px; border-top: 1px solid var(--divider); padding-top: 10px;">
                    <span class="resale-label" style="color: var(--text-secondary);">–ü—Ä–æ—Ü–µ–Ω—Ç –ú–∞—Ä–∂–∏ (%)</span>
                    <span class="resale-value" id="res-margin-percent">0.0%</span>
                </div>
            </div>
        </div>

        <div id="rates" class="tab-content">
            <div class="rates-info" id="rates-timestamp">–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...</div>
            
            <div class="section-title" style="color: var(--text-secondary);">–¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã (1 USD)</div>
            <div id="all-rates-list"></div>
            
            <div class="section-title" style="color: var(--text-secondary);">–ò—Å—Ç–æ—Ä–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (7 –¥–Ω–µ–π)</div>
            <div class="history-section">
                <div style="text-align: right; margin-bottom: 10px;">
                    <button onclick="clearHistory()" class="btn clear" style="padding: 5px 10px; font-size: 0.8em; border-radius: 5px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <ul id="history-list"></ul>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–¥ JavaScript –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º.
        const calcBaseSelect = document.getElementById('base-currency-calc');
        const input = document.getElementById('input-value');
        const historyList = document.getElementById('history-list');
        const ratesTimestamp = document.getElementById('rates-timestamp');
        const converterResults = document.getElementById('converter-results');
        const allRatesList = document.getElementById('all-rates-list');
        
        let currentExpression = '0';
        let isResultDisplayed = false;
        
        const API_KEY = 'fb34ef6c5c479e7e4461d838'; 
        const API_URL_BASE = 'https://v6.exchangerate-api.com/v6/';
        const HISTORY_KEY = 'deshmoneyHistory';
        const HISTORY_EXPIRATION_DAYS = 7; 
        
        let EXCHANGE_RATES = {}; 
        const ALL_CURRENCIES = ['USD', 'EUR', 'CNY', 'UAH', 'PLN', 'GBP', 'JPY', 'CAD', 'CHF', 'AUD']; 
        const CONVERTER_FAVORITES = ['EUR', 'PLN', 'CNY', 'USD', 'UAH']; 


        // ===================================
        // 1. –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ö–õ–ê–î–ö–ê–ú–ò
        // ===================================

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-button[onclick*='${tabName}']`).classList.add('active');
            
            if (tabName === 'rates') {
                renderAllRates();
                loadHistory(); 
            } else if (tabName === 'resale') {
                calculateResale();
            }
        }
        
        // ===================================
        // 2. –ó–ê–ì–†–£–ó–ö–ê –ö–£–†–°–û–í (–¢–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
        // ===================================

        async function fetchRates() {
            ratesTimestamp.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤...';
            
            try {
                const response = await fetch(`${API_URL_BASE}${API_KEY}/latest/USD`); 
                const data = await response.json();

                if (data.result === 'success') {
                    EXCHANGE_RATES = data.conversion_rates;
                    
                    const time = new Date(data.time_last_update_unix * 1000);
                    ratesTimestamp.textContent = `–ö—É—Ä—Å—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞: ${time.toLocaleDateString()} ${time.toLocaleTimeString()}`;
                    
                    updateConverter(currentExpression); 
                    renderConverterFavorites(); 
                    renderAllRates(); 
                    calculateResale();
                } else {
                    ratesTimestamp.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á API.';
                }
            } catch (error) {
                ratesTimestamp.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.';
            }
        }
        
        // ===================================
        // 3. –§–£–ù–ö–¶–ò–û–ù–ê–õ –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ê
        // ===================================

        function quickSwitchBase(code) {
            calcBaseSelect.value = code;
            localStorage.setItem('deshmoneyBaseCurrency', code);
            updateConverter(input.value);
        }
        
        function setQuickBase(amount) {
            currentExpression = String(amount);
            input.value = currentExpression;
            updateConverter(currentExpression);
            isResultDisplayed = false;
        }

        function backspaceInput() {
            if (isResultDisplayed) {
                currentExpression = '0';
                isResultDisplayed = false;
            } else {
                currentExpression = currentExpression.slice(0, -1);
                if (currentExpression === '' || currentExpression === '-') {
                    currentExpression = '0';
                }
            }
            input.value = currentExpression;
            updateConverter(currentExpression);
        }
        
        function appendInput(value) {
            if (isResultDisplayed && /[0-9.]/.test(value)) {
                currentExpression = value;
                isResultDisplayed = false;
            } else if (isResultDisplayed && !/[0-9.]/.test(value)) {
                currentExpression = input.value.replace(/,/g, '') + value;
                isResultDisplayed = false;
            } else {
                const lastChar = currentExpression.slice(-1);
                const isLastCharOperator = ['+', '-', '√ó', '√∑'].includes(lastChar);
                const isNewValueOperator = ['+', '-', '√ó', '√∑'].includes(value);

                if (isNewValueOperator && isLastCharOperator) {
                    currentExpression = currentExpression.slice(0, -1) + value; 
                } else if (currentExpression === '0' && value !== '.') {
                    currentExpression = value;
                } else {
                    currentExpression += value;
                }
            }
            input.value = currentExpression;
            updateConverter(currentExpression);
        }

        function clearInput() {
            currentExpression = '0';
            input.value = '0';
            isResultDisplayed = false;
            updateConverter('0');
        }

        function calculateResult() {
            try {
                const safeExpression = currentExpression.replace(/√ó/g, '*').replace(/√∑/g, '/');
                const result = eval(safeExpression);
                
                addToHistory(safeExpression, result, calcBaseSelect.value, 'calculation'); 

                currentExpression = String(result);
                input.value = result.toLocaleString('en-US', {maximumFractionDigits: 10});
                
                isResultDisplayed = true;
                updateConverter(result); 
            } catch (e) {
                input.value = '–û—à–∏–±–∫–∞';
                currentExpression = '0';
                isResultDisplayed = true;
                updateConverter('0');
            }
        }
        
        // –í–≤–æ–¥ —Å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
        document.addEventListener('keydown', (event) => {
            const key = event.key;
            
            if (document.activeElement.tagName.toLowerCase() === 'input' && document.activeElement.type === 'number') {
                return; // –ù–µ –≤–º–µ—à–∏–≤–∞–µ–º—Å—è, –µ—Å–ª–∏ –≤–≤–æ–¥ –∏–¥–µ—Ç –≤ –ø–æ–ª–µ —Ç–∏–ø–∞ number
            }

            if (/[0-9.]/.test(key)) {
                appendInput(key);
            } else if (key === '+' || key === '-' || key === '*' || key === '/') {
                event.preventDefault(); 
                appendInput(key === '/' ? '√∑' : (key === '*' ? '√ó' : key));
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault();
                calculateResult();
            } else if (key === 'Escape') {
                clearInput();
            } else if (key === 'Backspace') {
                 backspaceInput();
            }
        });

        // ===================================
        // 4. –õ–û–ì–ò–ö–ê –ö–û–ù–í–ï–†–¢–ï–†–ê
        // ===================================

        function renderConverterFavorites() {
            converterResults.innerHTML = '';
            CONVERTER_FAVORITES.forEach(target => {
                const element = document.createElement('div');
                element.className = 'currency-item';
                element.innerHTML = `
                    <span class="currency-name">${getCurrencyFlag(target)} ${target}</span>
                    <span class="currency-rate" id="res-${target.toLowerCase()}">0.00</span>
                `;
                converterResults.appendChild(element);
            });
        }

        function updateConverter(amountStr) {
            let amount = parseFloat(String(amountStr).replace(/,/g, '')) || 0;
            const baseCurrency = calcBaseSelect.value;
            
            if (Object.keys(EXCHANGE_RATES).length === 0) { return; }

            let amountInUSD = 0;
            if (baseCurrency === 'USD') {
                amountInUSD = amount;
            } else if (EXCHANGE_RATES[baseCurrency]) {
                amountInUSD = amount / EXCHANGE_RATES[baseCurrency];
            }
            
            CONVERTER_FAVORITES.forEach(target => {
                let finalResult = 0;
                
                if (target === 'USD') {
                    finalResult = amountInUSD;
                } else if (EXCHANGE_RATES[target]) {
                    finalResult = amountInUSD * EXCHANGE_RATES[target];
                }

                const element = document.getElementById('res-' + target.toLowerCase());
                if (element) {
                     const color = (target === baseCurrency) ? 'var(--text-main)' : 'var(--graph-color)';
                     element.style.color = color;
                    element.textContent = finalResult.toLocaleString('en-US', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
                }
            });
        }
        
        // ===================================
        // 5. –õ–û–ì–ò–ö–ê –†–ï–°–ï–ô–õ-–ö–û–ù–í–ï–†–¢–ï–†–ê
        // ===================================
        
        function calculateResale() {
            const costBase = parseFloat(document.getElementById('resale-cost').value) || 0;
            const salePriceGross = parseFloat(document.getElementById('resale-sale-price').value) || 0;
            const commissionRate = parseFloat(document.getElementById('resale-commission').value) / 100 || 0;
            const shipping = parseFloat(document.getElementById('resale-shipping').value) || 0;
            const vatRate = parseFloat(document.getElementById('resale-vat').value) / 100 || 0;
            
            const baseCode = document.getElementById('resale-base-currency').value;
            const targetCode = document.getElementById('resale-target-currency').value;

            if (Object.keys(EXCHANGE_RATES).length === 0) {
                // –°–±—Ä–æ—Å, –µ—Å–ª–∏ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤
                document.getElementById('res-sale-net').textContent = '0.00';
                document.getElementById('res-cost-target').textContent = '0.00';
                document.getElementById('res-profit').textContent = '0.00';
                document.getElementById('res-margin-percent').textContent = '0.0%';
                return;
            }
            
            const targetSymbol = getCurrencySymbol(targetCode);
            
            // 1. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ü–µ–ª–µ–≤—É—é –≤–∞–ª—é—Ç—É
            const costInUSD = costBase / EXCHANGE_RATES[baseCode];
            let costTargetCurrency = costInUSD * EXCHANGE_RATES[targetCode];

            // 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ù–î–°/–ü–æ—à–ª–∏–Ω—ã –∫ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
            if (vatRate > 0) {
                 costTargetCurrency = costTargetCurrency * (1 + vatRate);
            }
            
            // 3. –†–∞—Å—á–µ—Ç —á–∏—Å—Ç–æ–π —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏
            const commissionAmount = salePriceGross * commissionRate;
            const salePriceNet = salePriceGross - commissionAmount - shipping;

            // 4. –†–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏ –∏ –º–∞—Ä–∂–∏
            const profit = salePriceNet - costTargetCurrency;
            const marginPercent = (salePriceNet > 0) ? (profit / salePriceNet) * 100 : 0;
            
            // 5. –í—ã–≤–æ–¥
            document.getElementById('res-sale-net').textContent = `${salePriceNet.toFixed(2)} ${targetSymbol}`;
            document.getElementById('res-cost-target').textContent = `${costTargetCurrency.toFixed(2)} ${targetSymbol}`;
            document.getElementById('res-profit').textContent = `${profit.toFixed(2)} ${targetSymbol}`;
            document.getElementById('res-margin-percent').textContent = `${marginPercent.toFixed(1)}%`;
        }
        
        function saveDeal() {
            const costBase = parseFloat(document.getElementById('resale-cost').value) || 0;
            const salePriceGross = parseFloat(document.getElementById('resale-sale-price').value) || 0;
            
            if (costBase === 0 || salePriceGross === 0) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ø–æ–∫—É–ø–∫–∏ –∏ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏.");
                return;
            }
            
            calculateResale();
            const profit = document.getElementById('res-profit').textContent;
            const margin = document.getElementById('res-margin-percent').textContent;
            const targetCode = document.getElementById('resale-target-currency').value;
            
            const dealName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ö—É—Ä—Ç–∫–∞ Arcteryx Taobao'):");
            
            if (dealName) {
                const expression = `${dealName} (–ü–æ–∫—É–ø–∫–∞: ${costBase} ${document.getElementById('resale-base-currency').value})`;
                const result = `–ü—Ä–∏–±—ã–ª—å: ${profit} | –ú–∞—Ä–∂–∞: ${margin}`;
                addToHistory(expression, result, targetCode, 'resale');
                alert(`–°–¥–µ–ª–∫–∞ "${dealName}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ò—Å—Ç–æ—Ä–∏–∏!`);
            }
        }
        
        // ===================================
        // 6. –õ–û–ì–ò–ö–ê –ò–°–¢–û–†–ò–ò
        // ===================================
        
        function loadHistory() {
            try {
                const storedHistory = localStorage.getItem(HISTORY_KEY);
                let history = storedHistory ? JSON.parse(storedHistory) : [];
                const sevenDaysAgo = Date.now() - (HISTORY_EXPIRATION_DAYS * 24 * 60 * 60 * 1000);
                history = history.filter(item => item.timestamp > sevenDaysAgo);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                renderHistory(history);
                return history;
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:", e);
                return [];
            }
        }

        function renderHistory(history) {
            historyList.innerHTML = '';
            if (history.length === 0) {
                 historyList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</li>';
                 return;
            }
            
            [...history].reverse().forEach(item => { 
                const listItem = document.createElement('li');
                listItem.className = 'history-item';
                
                const date = new Date(item.timestamp).toLocaleDateString();
                const typeLabel = item.type === 'resale' ? 'üíº –°–î–ï–õ–ö–ê' : 'üßÆ –†–ê–°–ß–ï–¢';
                
                listItem.innerHTML = `
                    <span style="font-weight: 600; color: var(--text-main);" title="${date}">${typeLabel}: ${item.expression}</span>
                    <span class="history-result">
                        ${item.type === 'resale' ? item.result : `${parseFloat(item.result).toLocaleString('en-US', {maximumFractionDigits: 5})} ${item.base}`}
                    </span>
                `;
                historyList.appendChild(listItem);
            });
        }
        
        function addToHistory(expression, result, base, type) {
            let history = loadHistory(); 
            
            history.push({
                expression: expression,
                result: result,
                base: base,
                timestamp: Date.now(),
                type: type
            });
            
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function clearHistory() {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –≤—ã—á–∏—Å–ª–µ–Ω–∏–π?")) {
                localStorage.removeItem(HISTORY_KEY);
                renderHistory([]);
                alert("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞!");
            }
        }

        // ===================================
        // 7. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ===================================
        
        function getCurrencyFlag(code) {
            const flags = { 'USD': 'üá∫üá∏', 'EUR': 'üá™üá∫', 'CNY': 'üá®üá≥', 'UAH': 'üá∫üá¶', 'PLN': 'üáµüá±', 'GBP': 'üá¨üáß', 'JPY': 'üáØüáµ', 'CAD': 'üá®üá¶', 'CHF': 'üá®üá≠', 'AUD': 'üá¶üá∫' };
            return flags[code] || 'üåê';
        }
        
        function getCurrencySymbol(code) {
            const symbols = { 'USD': '$', 'EUR': '‚Ç¨', 'CNY': '¬•', 'UAH': '‚Ç¥', 'PLN': 'z≈Ç' };
            return symbols[code] || code;
        }

        // ===================================
        // 8. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ===================================
        
        const savedBaseCurrency = localStorage.getItem('deshmoneyBaseCurrency');
        if (savedBaseCurrency) {
            calcBaseSelect.value = savedBaseCurrency;
        }
        calcBaseSelect.addEventListener('change', () => {
            localStorage.setItem('deshmoneyBaseCurrency', calcBaseSelect.value);
            updateConverter(input.value);
        });
        
        input.value = '0';
        renderConverterFavorites(); 
        fetchRates(); 
        
        document.getElementById('resale-cost').value = 100;
        document.getElementById('resale-sale-price').value = 200;
        document.getElementById('resale-commission').value = 10;
        document.getElementById('resale-shipping').value = 15;
        document.getElementById('resale-vat').value = 0;
    </script>
</body>
</html>